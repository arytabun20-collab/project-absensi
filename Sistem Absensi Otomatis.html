<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absen Otomatis</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
      (function(){
          // Ganti YOUR_PUBLIC_KEY dengan Public Key Anda dari Akun EmailJS
          emailjs.init({ publicKey: "ziS95MemIgRkjCG3l" }); // public key
      })();
    </script>

    <style>
        /* Menerapkan font Inter ke seluruh halaman */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Menyembunyikan halaman yang tidak aktif secara default */
        #halaman-daftar, #halaman-absen, #modal-konfirmasi {
            display: none;
        }
        /* Style untuk tombol yang nonaktif */
        button:disabled {
            background-color: #9ca3af; /* gray-400 */
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen py-12">

    <div class="container mx-auto p-4 max-w-md w-full">

        <div id="halaman-login" class="bg-white p-8 rounded-xl shadow-lg">
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Login Akun</h1>
            <form id="form-login">
                <div class="mb-4">
                    <label for="login-email" class="block text-gray-700 text-sm font-bold mb-2">Alamat Email</label>
                    <input type="email" id="login-email" name="email" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="contoh@email.com">
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                    <input type="password" id="login-password" name="password" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="******************">
                </div>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg w-full focus:outline-none focus:shadow-outline transition duration-300">
                    Login
                </button>
                <div class="text-center mt-4">
                    <button type="button" id="link-ke-daftar" class="text-sm text-gray-500 hover:text-blue-600 underline">Belum punya akun? Daftar di sini</button>
                </div>
            </form>
        </div>
        
        <div id="halaman-daftar" class="bg-white p-8 rounded-xl shadow-lg">
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Daftar Akun Baru</h1>
            <form id="form-daftar">
                <div class="mb-4">
                    <label for="daftar-email" class="block text-gray-700 text-sm font-bold mb-2">Alamat Email</label>
                    <input type="email" id="daftar-email" name="email" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="contoh@email.com">
                </div>
                <div class="mb-6">
                    <label for="daftar-password" class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                    <input type="password" id="daftar-password" name="password" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Buat password Anda">
                </div>
                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg w-full focus:outline-none focus:shadow-outline transition duration-300">
                    Daftar
                </button>
                <div class="text-center mt-4">
                    <button type="button" id="link-ke-login" class="text-sm text-gray-500 hover:text-blue-600 underline">Sudah punya akun? Login di sini</button>
                </div>
            </form>
        </div>


        <div id="halaman-absen" class="bg-white p-8 rounded-xl shadow-lg">
            <div class="text-center mb-6 relative">
                <h1 class="text-3xl font-bold text-gray-800">Sistem Absen Otomatis</h1>
                <p class="text-gray-600 mt-2">Program Studi Pendidikan Teknik Elektro</p>
            </div>
            
            <form id="form-absen" novalidate>
                <div class="mb-4">
                    <label for="nama" class="block text-gray-700 text-sm font-bold mb-2">Masukkan Nama Anda</label>
                    <input type="text" id="nama" name="nama" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nama Lengkap">
                </div>
                <div class="mb-4">
                    <label for="nim" class="block text-gray-700 text-sm font-bold mb-2">Nomor Induk Mahasiswa</label>
                    <input type="text" id="nim" name="nim" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: 2105551001">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="bg-gray-50 p-4 rounded-lg text-center">
                        <p class="text-sm font-bold text-gray-500">Tanggal</p>
                        <p id="tanggal-otomatis" class="text-gray-800 font-semibold"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg text-center">
                        <p class="text-sm font-bold text-gray-500">Waktu</p>
                        <p id="waktu-otomatis" class="text-gray-800 font-semibold"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg text-center md:col-span-1">
                        <p class="text-sm font-bold text-gray-500">Status Minggu</p>
                        <p id="status-minggu" class="text-gray-800 font-semibold text-blue-600"></p>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="kampus" class="block text-gray-700 text-sm font-bold mb-2">Nama Kampus</label>
                    <input type="text" id="kampus" name="kampus" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nama Perguruan Tinggi">
                </div>
                <div class="mb-6">
                    <label for="foto" class="block text-gray-700 text-sm font-bold mb-2">Upload Foto</label>
                    <input type="file" id="foto" name="foto" required accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <p id="nama-file" class="text-xs text-gray-500 mt-1"></p>
                </div>
                <div class="grid grid-cols-2 gap-4 mt-6">
                    <button id="btn-absen-masuk" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition duration-300">Absen Masuk</button>
                    <button id="btn-absen-pulang" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition duration-300">Absen Pulang</button>
                </div>
                <div class="text-center mt-6">
                    <button type="button" id="btn-logout" class="text-sm text-gray-500 hover:text-blue-600 underline transition duration-300">Logout</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-konfirmasi" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-lg text-center max-w-sm w-full">
            <h2 id="modal-judul" class="text-2xl font-bold mb-4"></h2>
            <p id="pesan-modal" class="text-gray-700 mb-6"></p>
            <button id="tombol-tutup-modal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Tutup</button>
        </div>
    </div>


    <script>
        // --- Mengambil elemen dari DOM ---
        const halamanLogin = document.getElementById('halaman-login');
        const halamanDaftar = document.getElementById('halaman-daftar');
        const halamanAbsen = document.getElementById('halaman-absen');
        
        const formLogin = document.getElementById('form-login');
        const formDaftar = document.getElementById('form-daftar');
        const formAbsen = document.getElementById('form-absen');

        const linkKeDaftar = document.getElementById('link-ke-daftar');
        const linkKeLogin = document.getElementById('link-ke-login');

        const inputNim = document.getElementById('nim');
        const inputFoto = document.getElementById('foto');
        const namaFileDisplay = document.getElementById('nama-file');
        
        const btnAbsenMasuk = document.getElementById('btn-absen-masuk');
        const btnAbsenPulang = document.getElementById('btn-absen-pulang');
        const btnLogout = document.getElementById('btn-logout');

        // [BARU] Ambil elemen status minggu
        const statusMingguEl = document.getElementById('status-minggu');

        const modalKonfirmasi = document.getElementById('modal-konfirmasi');
        const modalJudul = document.getElementById('modal-judul');
        const pesanModal = document.getElementById('pesan-modal');
        const tombolTutupModal = document.getElementById('tombol-tutup-modal');
        
        let intervalWaktu;
        let loggedInUserEmail = null;

        // --- Fungsi Helper ---
        const getTodayDateString = () => new Date().toISOString().slice(0, 10);

        const tampilkanModal = (judul, pesan, isError = false) => {
            modalJudul.textContent = judul;
            pesanModal.innerHTML = pesan; // Gunakan innerHTML untuk render status
            modalJudul.className = `text-2xl font-bold mb-4 ${isError ? 'text-red-600' : 'text-green-600'}`;
            modalKonfirmasi.style.display = 'flex';
        };
        
        // ===============================================
        // [BARU] LOGIKA UNTUK STATUS MINGGU GANJIL/GENAP
        // ===============================================
        
        // Helper untuk mengubah format 'DD-MM-YYYY' menjadi objek Date
        const parseDate = (dateString) => {
            const [day, month, year] = dateString.split('-').map(Number);
            return new Date(year, month - 1, day);
        };

        // Definisikan rentang tanggal untuk Minggu Ganjil
        const ganjilRanges = [
            { start: parseDate('21-07-2025'), end: parseDate('25-07-2025') },
            { start: parseDate('04-08-2025'), end: parseDate('08-08-2025') },
            { start: parseDate('18-08-2025'), end: parseDate('22-08-2025') },
            { start: parseDate('01-09-2025'), end: parseDate('04-09-2025') },
            { start: parseDate('15-09-2025'), end: parseDate('19-09-2025') },
            { start: parseDate('29-09-2025'), end: parseDate('30-09-2025') },
            { start: parseDate('01-10-2025'), end: parseDate('03-10-2025') },
            { start: parseDate('13-10-2025'), end: parseDate('17-10-2025') },
            { start: parseDate('27-10-2025'), end: parseDate('29-10-2025') }
        ];

        // Definisikan rentang tanggal untuk Minggu Genap
        const genapRanges = [
            { start: parseDate('28-07-2025'), end: parseDate('01-08-2025') },
            { start: parseDate('11-08-2025'), end: parseDate('15-08-2025') },
            { start: parseDate('25-08-2025'), end: parseDate('29-08-2025') },
            { start: parseDate('08-09-2025'), end: parseDate('12-09-2025') }, // Typo diperbaiki dari Agustus ke September
            { start: parseDate('22-09-2025'), end: parseDate('26-09-2025') },
            { start: parseDate('06-10-2025'), end: parseDate('10-10-2025') },
            { start: parseDate('20-10-2025'), end: parseDate('24-10-2025') },
            { start: parseDate('03-11-2025'), end: parseDate('07-11-2025') }
        ];

        // Fungsi untuk mengecek tanggal dan mengembalikan status minggu
        function getStatusMinggu() {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset waktu agar hanya membandingkan tanggal

            for (const range of ganjilRanges) {
                if (today >= range.start && today <= range.end) {
                    return 'Minggu Ganjil';
                }
            }
            for (const range of genapRanges) {
                if (today >= range.start && today <= range.end) {
                    return 'Minggu Genap';
                }
            }
            return 'Luar Periode Absensi';
        }


        const goToAbsenPage = () => {
              halamanLogin.style.display = 'none';
              halamanDaftar.style.display = 'none';
              halamanAbsen.style.display = 'block';
              updateWaktu(); 
              intervalWaktu = setInterval(updateWaktu, 1000);
              updateAbsenButtonsUI();
              // [BARU] Set status minggu saat halaman absen ditampilkan
              statusMingguEl.textContent = getStatusMinggu();
        }

        // --- Navigasi antara Login dan Daftar ---
        linkKeDaftar.addEventListener('click', () => {
            halamanLogin.style.display = 'none';
            halamanDaftar.style.display = 'block';
        });

        linkKeLogin.addEventListener('click', () => {
            halamanDaftar.style.display = 'none';
            halamanLogin.style.display = 'block';
        });

        // --- Logika Registrasi ---
        formDaftar.addEventListener('submit', (event) => {
            event.preventDefault();
            const email = document.getElementById('daftar-email').value;
            const password = document.getElementById('daftar-password').value;

            if (!email || !password) {
                tampilkanModal('Gagal', 'Email dan password tidak boleh kosong.', true);
                return;
            }

            let userCredentials = JSON.parse(localStorage.getItem('user_credentials')) || {};

            if (userCredentials[email]) {
                tampilkanModal('Registrasi Gagal', 'Email ini sudah terdaftar. Silakan login.', true);
            } else {
                userCredentials[email] = password;
                localStorage.setItem('user_credentials', JSON.stringify(userCredentials));
                tampilkanModal('Registrasi Berhasil', `Akun untuk ${email} telah dibuat. Silakan login untuk melanjutkan.`);
                halamanDaftar.style.display = 'none';
                halamanLogin.style.display = 'block';
                formDaftar.reset();
            }
        });

        // --- Logika Login ---
        formLogin.addEventListener('submit', (event) => {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            let userCredentials = JSON.parse(localStorage.getItem('user_credentials')) || {};

            if (userCredentials[email] && userCredentials[email] === password) {
                loggedInUserEmail = email;
                goToAbsenPage();
            } else {
                tampilkanModal('Login Gagal', 'Email atau password salah.', true);
            }
        });

        // --- Logika Logout ---
        btnLogout.addEventListener('click', () => {
            halamanAbsen.style.display = 'none';
            halamanLogin.style.display = 'block';
            formAbsen.reset();
            formLogin.reset();
            namaFileDisplay.textContent = '';
            clearInterval(intervalWaktu);
            loggedInUserEmail = null;
        });

        // --- Sisa logika (Absensi, Waktu, dll) ---
        function updateWaktu() {
            const sekarang = new Date();
            const opsiTanggal = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('tanggal-otomatis').textContent = sekarang.toLocaleDateString('id-ID', opsiTanggal);
            document.getElementById('waktu-otomatis').textContent = sekarang.toLocaleTimeString('id-ID');
        }

        function updateAbsenButtonsUI() {
            const nim = inputNim.value;
            if (!nim) {
                btnAbsenMasuk.disabled = false;
                btnAbsenPulang.disabled = false;
                return;
            };
            const today = getTodayDateString();
            const key = `absen_${nim}_${today}`;
            const dataAbsen = JSON.parse(localStorage.getItem(key)) || {};
            btnAbsenMasuk.disabled = !!dataAbsen.masuk;
            btnAbsenPulang.disabled = !!dataAbsen.pulang;
        }
        
        inputNim.addEventListener('input', updateAbsenButtonsUI);

        inputFoto.addEventListener('change', () => {
            namaFileDisplay.textContent = inputFoto.files.length > 0 ? `File dipilih: ${inputFoto.files[0].name}` : '';
        });

        btnAbsenMasuk.addEventListener('click', (e) => {
            e.preventDefault();
            handleAbsen('Masuk');
        });

        btnAbsenPulang.addEventListener('click', (e) => {
            e.preventDefault();
            handleAbsen('Pulang');
        });

        // ========================================================
        // [MODIFIKASI] FUNGSI HANDLE ABSEN DENGAN LOGIKA BARU
        // ========================================================
        function handleAbsen(tipeAbsen) {
            if (!formAbsen.checkValidity()) {
                formAbsen.reportValidity();
                return;
            }
            const nim = inputNim.value;
            const today = getTodayDateString();
            const key = `absen_${nim}_${today}`;
            const dataAbsen = JSON.parse(localStorage.getItem(key)) || {};

            if (tipeAbsen === 'Masuk' && dataAbsen.masuk) {
                tampilkanModal('Gagal', 'Anda sudah melakukan absen masuk hari ini.', true);
                return;
            }
            if (tipeAbsen === 'Pulang') {
                if (!dataAbsen.masuk) {
                    tampilkanModal('Gagal', 'Anda harus melakukan absen masuk terlebih dahulu.', true);
                    return;
                }
                if (dataAbsen.pulang) {
                    tampilkanModal('Gagal', 'Anda sudah melakukan absen pulang hari ini.', true);
                    return;
                }
            }

            const waktuSekarangObj = new Date();
            const waktuSekarangString = waktuSekarangObj.toLocaleTimeString('id-ID');
            let statusKehadiran = '-';
            let pesanStatus = '';

            // [BARU] Logika penentuan status Hadir/Terlambat
            if (tipeAbsen === 'Masuk') {
                const batasWaktuMasuk = new Date();
                batasWaktuMasuk.setHours(7, 5, 0, 0); // Batas waktu 07:05:00

                if (waktuSekarangObj > batasWaktuMasuk) {
                    statusKehadiran = 'Terlambat';
                    pesanStatus = `<br>Status Kehadiran: <strong class="text-red-600">${statusKehadiran}</strong>`;
                } else {
                    statusKehadiran = 'Hadir';
                    pesanStatus = `<br>Status Kehadiran: <strong class="text-green-600">${statusKehadiran}</strong>`;
                }
                dataAbsen.status = statusKehadiran; // Simpan status
                dataAbsen.masuk = waktuSekarangString;
            } else {
                dataAbsen.pulang = waktuSekarangString;
            }
            
            localStorage.setItem(key, JSON.stringify(dataAbsen));
            
            tampilkanModal('Berhasil!', `Absensi ${tipeAbsen} pada pukul ${waktuSekarangString} telah berhasil direkam.${pesanStatus}`);
            updateAbsenButtonsUI();
            kirimEmail(tipeAbsen, dataAbsen);
        }
        
        // =====================================================
        // [MODIFIKASI] FUNGSI KIRIM EMAIL DENGAN DATA BARU
        // =====================================================
        function kirimEmail(tipeAbsen, dataAbsenLengkap) {
            const nama = document.getElementById('nama').value;
            const nim = inputNim.value;
            const kampus = document.getElementById('kampus').value;
            const foto = inputFoto.files[0];
            const statusMinggu = statusMingguEl.textContent; // Ambil status minggu dari UI

            console.log(`Data Absen ${tipeAbsen} Siap Dikirim ke Email dari ${loggedInUserEmail}:`, {
                tipe: tipeAbsen, nama, nim, kampus,
                data_harian: dataAbsenLengkap,
                status_minggu: statusMinggu
            });
            
            if (!foto) { 
                tampilkanModal('Gagal Mengirim', 'Foto bukti absensi wajib diunggah.', true);
                return; 
            }
            const reader = new FileReader();
            reader.readAsDataURL(foto);
            reader.onloadend = function() {
                const base64String = reader.result;
                const ekstensiFile = foto.type.split('/')[1];
                
                // Tambahkan 'status_kehadiran' dan 'status_minggu' ke template
                const templateParams = {
                    tipe_absen: tipeAbsen,
                    waktu_masuk: dataAbsenLengkap.masuk || '-',
                    waktu_pulang: dataAbsenLengkap.pulang || '-',
                    status_kehadiran: dataAbsenLengkap.status || '-', // [BARU]
                    status_minggu: statusMinggu, // [BARU]
                    from_name: nama,
                    nim: nim,
                    kampus: kampus,
                    tanggal: document.getElementById('tanggal-otomatis').textContent,
                    foto_base64: base64String,
                    foto_ekstensi: ekstensiFile,
                    reply_to: loggedInUserEmail
                };

                // Pastikan Anda sudah menambahkan {{status_kehadiran}} dan {{status_minggu}} di template EmailJS Anda
                if(typeof emailjs !== 'undefined') {
                    // Ganti YOUR_SERVICE_ID dan YOUR_TEMPLATE_ID dengan milik Anda
                    emailjs.send('service_crd8v2r', 'template_8md9mzv', templateParams)
                        .then(function(response) { 
                            console.log('EMAIL SENT!', response.status, response.text); 
                            tampilkanModal('Sukses Terkirim', 'Data absensi Anda telah berhasil dikirim ke email.');
                        }, 
                        function(error) { 
                            console.log('EMAIL FAILED...', error); 
                            tampilkanModal('Gagal Terkirim', 'Terjadi kesalahan saat mengirim data absensi ke email.', true);
                        });
                } else { 
                    console.error("EmailJS belum diinisialisasi. Periksa konfigurasi di <head>."); 
                    tampilkanModal('Konfigurasi Error', 'Layanan pengiriman email belum siap. Hubungi administrator.', true);
                }
            }
        }

        tombolTutupModal.addEventListener('click', () => {
            modalKonfirmasi.style.display = 'none';
        });

    </script>
</body>
</html>